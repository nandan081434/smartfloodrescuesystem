<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Citizen Home | Flood Rescue</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Poppins',sans-serif;
}

body{
    height:100vh;
    overflow:hidden;
}

/* MAP FULL SCREEN */
#map{
    height:100vh;
    width:100vw;
}

/* FLOATING SIDEBAR */
.sidebar{
    position:absolute;
    top:20px;
    left:20px;
    width:200px;
    display:flex;
    flex-direction:column;
    gap:20px;
    z-index:1000;
}

/* TITLE */
.app-title{
    color:#0ea5e9;
    font-size:18px;
    font-weight:600;
    text-align:center;
    margin-bottom:10px;
}

/* FLOATING BUTTONS */
.menu-btn,
.menu-item{
    height:64px;
    border:none;
    border-radius:22px;
    font-size:16px;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:14px;
    padding-left:22px;
    color:#fff;

    background:rgba(15,23,42,0.85);
    backdrop-filter:blur(12px);
    box-shadow:0 10px 26px rgba(0,0,0,0.45);

    transition:0.3s;
}

.menu-item p{
    margin:0;
}

.menu-btn:hover,
.menu-item:hover{
    transform:translateX(6px) scale(1.03);
    background:#2563eb;
}

/* ICON */
.icon{
    font-size:22px;
}

/* SOS */
.sos{
    background:#b91c1c;
    font-weight:600;
}

.sos:hover{
    background:#dc2626;
}

/* TOP MESSAGE */
.top-info{
    position:absolute;
    top:20px;
    left:260px;
    background:rgba(0,0,0,0.75);
    color:white;
    padding:14px 26px;
    border-radius:18px;
    z-index:1000;
    font-size:14px;
    animation:fadeOut 2s forwards;
}

@keyframes fadeOut{
    0%{opacity:1;}
    70%{opacity:1;}
    100%{opacity:0; visibility:hidden;}
}

/* PROFILE IMAGE MARKER */
.user-marker{
    width:52px;
    height:52px;
    border-radius:50%;
    overflow:hidden;
    border:3px solid #ef4444;
    background:white;
}

.user-marker img{
    width:100%;
    height:100%;
    object-fit:cover;
}
</style>
</head>

<body>

<!-- LOGIN SUCCESS BAR -->
<div id="loginSuccessBar" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #16a34a;
  color: white;
  text-align: center;
  padding: 14px;
  font-weight: 600;
  display: none;
  z-index: 9999;
">
</div>

<!-- MAP -->
<div id="map"></div>

<!-- FLOATING SIDEBAR -->
<div class="sidebar">
    <div class="app-title">üåä Flood Rescue</div>

    <div class="menu-item" onclick="openProfile()">
        <span class="icon">üë§</span>
        <p>Profile</p>
    </div>

    <button class="menu-btn" onclick="goToSuggestion()">
    <span class="icon">üí°</span> Suggestion Box
</button>
<script>
function goToSuggestion() {
    window.location.href = "ai_project/ai_citizen/SMART_FLOOD_RESCUE_APP/frontend/index.html";
}
</script>

    <button class="menu-btn">
        <span class="icon">üè†</span> Home
    </button>

    <!-- SOS BUTTON -->
    <button class="menu-btn sos" onclick="openSOS()">
        <span class="icon">üö®</span> SOS
    </button>

<button class="menu-btn" onclick="goToCitizenAlerts()">
    <span class="icon">üîî</span> Alerts
</button>

<script>
function goToCitizenAlerts() {
    window.location.href = "alerts/alerts.html";
}
</script>
</div>

<!-- MESSAGE -->
<div class="top-info" id="topInfo">
    üìç Your live location is being tracked
</div>

<script>
/* MAP INIT */
const map = L.map('map').setView([18.3221, 78.3033], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

/* DEFAULT MARKER */
L.marker([18.3221, 78.3033])
 .addTo(map)
 .bindPopup("üìç Your location");

/* PROFILE IMAGE MARKER */
const avatar = localStorage.getItem("profileAvatar");

if (avatar && avatar.trim() !== "") {
  const profileIcon = L.divIcon({
    className: "",
    html: `
      <div class="user-marker">
        <img src="${avatar}">
      </div>
    `,
    iconSize: [52, 52],
    iconAnchor: [26, 52]
  });

  L.marker([18.3221, 78.3033], { icon: profileIcon })
    .addTo(map)
    .bindPopup("üë§ You");
}

/* REMOVE MESSAGE */
setTimeout(()=>{
    const msg=document.getElementById("topInfo");
    if(msg) msg.remove();
},2000);

/* NAVIGATION */
function openProfile(){
    window.location.href = "profile.html";
}

/* SOS NAVIGATION */
function openSOS(){
    localStorage.setItem("sosActive","true"); // ‚úÖ ADD
    window.location.href = "sos.html";
}

/* LOGIN SUCCESS BAR */
const floodUser = JSON.parse(localStorage.getItem("floodUser"));

if (floodUser && floodUser.email) {
    const bar = document.getElementById("loginSuccessBar");
    bar.innerText = `‚úÖ Logged in successfully as ${floodUser.email}`;
    bar.style.display = "block";

    setTimeout(() => {
        bar.style.display = "none";
    }, 2000);
}

/* =================================================
   ‚úÖ ADD ONLY: LIVE GPS (ALWAYS ON)
================================================= */
let liveMarker = null;
let accuracyCircle = null;

navigator.geolocation.watchPosition(
    (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy;

        if(liveMarker){
            liveMarker.setLatLng([lat,lng]);
        }else{
            liveMarker = L.marker([lat,lng])
                .addTo(map)
                .bindPopup("üìç Live location");
        }

        if(accuracyCircle){
            accuracyCircle.setLatLng([lat,lng]);
            accuracyCircle.setRadius(acc);
        }else{
            accuracyCircle = L.circle([lat,lng],{
                radius:acc,
                color:"#2563eb",
                fillColor:"#3b82f6",
                fillOpacity:0.2
            }).addTo(map);
        }
    },
    ()=>{},
    {enableHighAccuracy:true}
);

/* =================================================
   ‚úÖ ADD ONLY: MOVEMENT + STOP (ONLY AFTER SOS)
================================================= */
let sosActive = localStorage.getItem("sosActive")==="true";

if(sosActive){

    let path = [];
    let trail = L.polyline([],{
        color:"#2563eb",
        weight:4
    }).addTo(map);

    let lastMove = Date.now();
    let lastPos = null;

    navigator.geolocation.watchPosition(
        (pos)=>{
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const point = [lat,lng];

            if(path.length===0 || map.distance(path[path.length-1],point)>5){
                path.push(point);
                trail.setLatLngs(path);
                lastMove = Date.now();
                lastPos = {lat,lng};
            }

            map.setView(point,map.getZoom(),{animate:true});
        }
    );

    setInterval(()=>{
        if(Date.now()-lastMove>60000){
            console.warn("‚ö†Ô∏è User not moving for 60 seconds");
        }
    },10000);
}
</script>
<script>
function openAlerts() {
    window.location.href = "alerts/alerts.html";
}
</script>

</body>
</html>
